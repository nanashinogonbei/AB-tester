<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アクセス解析 - Webトラッカー</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen flex">
    <aside class="w-64 bg-white min-h-screen border-r">
      <div class="p-6">
        <div class="mt-4 space-y-1">
          <div class="px-4 py-2 text-sm"><a href="./admin.html">プロジェクト管理</a></div>
          <div class="px-4 py-2 text-sm text-gray-500"><a href="./account_index.html">アカウント管理</a></div>
          <div class="px-4 py-2 text-sm"><a href="#" id="logout-btn" class="text-red-600 hover:text-red-800">ログアウト</a>
        </div>
      </div>
    </aside>

    <main class="flex-1 p-8">
      <div class="header">
        <div>
          <h1 id="project-name">読み込み中...</h1>
          <p id="project-url"></p>
        </div>
        <a href="admin.html">戻る</a>
      </div>

      <div class="section">
        <div class="section-title">期間</div>
        <div class="date-range">
          <input type="date" id="start-date">
          <span>〜</span>
          <input type="date" id="end-date">
        </div>
      </div>

      <div class="section">
        <div class="section-title">フィルター</div>
        <div class="filters" id="filters"></div>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">ユニークユーザー</div>
          <div class="stat-value" id="unique-users">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ページビュー</div>
          <div class="stat-value" id="page-views">-</div>
        </div>
        <div class="stat-card white">
          <div class="stat-label">人気ページ</div>
          <div id="popular-pages"></div>
        </div>
      </div>

      <div class="events-card">
        <div class="section-title">イベント</div>
        <div id="event-rows"></div>
        <button class="add-btn" id="add-event-btn">+</button>
      </div>
    </main>
  </div>

  <script>
    const API_URL = '/api';
    const projectId = new URLSearchParams(location.search).get('id');
    
    let project = null;
    let analyticsData = null;
    let suggestionData = null;
    let selectedFilters = { device: [], browser: [], os: [], language: ['ja'] };
    let eventRows = [];

    async function loadProject() {
      try {
        const res = await fetch(`${API_URL}/projects`);
        const projects = await res.json();
        project = projects.find(p => p._id === projectId);
        
        document.getElementById('project-name').textContent = project.name;
        document.getElementById('project-url').textContent = project.url;
      } catch (err) {
        console.error('Failed to load project:', err);
      }
    }

    async function loadSuggestions() {
      try {
        const res = await fetch(`${API_URL}/analytics/suggestions`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        suggestionData = await res.json();
        console.log('Suggestions loaded:', suggestionData);
      } catch (err) {
        console.error('Failed to load suggestions:', err);
        suggestionData = { devices: [], browsers: [], oss: [], languages: [] };
      }
    }

    async function loadAnalytics(keepDropdownOpen = false) {
      try {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        const params = new URLSearchParams({ start: startDate, end: endDate });
        Object.entries(selectedFilters).forEach(([key, values]) => {
          if (values.length > 0) params.set(key, values.join(','));
        });

        const res = await fetch(`${API_URL}/analytics/${projectId}?${params}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        analyticsData = await res.json();
        
        document.getElementById('unique-users').textContent = analyticsData.uniqueUsers;
        document.getElementById('page-views').textContent = analyticsData.pageViews.toLocaleString();
        
        document.getElementById('popular-pages').innerHTML = analyticsData.popularPages
          .slice(0, 3)
          .map((page, idx) => `
            <div class="popular-page">
              <span>${idx + 1}. ${page.url}</span>
              <span>${page.count}view</span>
            </div>
          `).join('');

        if (keepDropdownOpen) {
          updateFilterButtons();
        } else {
          renderFilters();
        }
        
        eventRows.forEach((_, idx) => loadEventCount(idx));
      } catch (err) {
        console.error('Failed to load analytics:', err);
      }
    }
    
    function updateFilterButtons() {
      document.querySelectorAll('.filter').forEach(filterDiv => {
        const btn = filterDiv.querySelector('.filter-btn');
        const dropdown = filterDiv.querySelector('.filter-dropdown');
        const key = dropdown.dataset.filterKey;
        const hasSelected = selectedFilters[key].length > 0;
        
        btn.className = 'filter-btn' + (hasSelected ? ' active' : '');
        const labels = { device: 'デバイス', browser: 'ブラウザ', os: 'OS', language: '言語' };
        btn.textContent = labels[key] + (hasSelected ? ' ✓' : '');
      });
    }

    function renderFilters() {
      const filtersContainer = document.getElementById('filters');
      
      const openDropdowns = [];
      document.querySelectorAll('.filter-dropdown.show').forEach(dd => {
        openDropdowns.push(dd.dataset.filterKey);
      });
      
      filtersContainer.innerHTML = '';
      
      [
        { label: 'デバイス', key: 'device', options: suggestionData.devices },
        { label: 'ブラウザ', key: 'browser', options: suggestionData.browsers },
        { label: 'OS', key: 'os', options: suggestionData.oss },
        { label: '言語', key: 'language', options: suggestionData.languages }
      ].forEach(filter => {
        const filterDiv = document.createElement('div');
        filterDiv.className = 'filter';
        
        const hasSelected = selectedFilters[filter.key].length > 0;
        
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (hasSelected ? ' active' : '');
        btn.textContent = filter.label + (hasSelected ? ' ✓' : '');
        btn.onclick = () => toggleFilter(filter.key);
        
        const dropdown = document.createElement('div');
        dropdown.className = 'filter-dropdown';
        dropdown.dataset.filterKey = filter.key;
        
        if (openDropdowns.includes(filter.key)) {
          dropdown.classList.add('show');
        }
        
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'filter-search';
        searchInput.placeholder = `${filter.label}を検索...`;
        searchInput.onclick = (e) => e.stopPropagation();
        searchInput.oninput = (e) => filterOptions(filter.key, e.target.value);
        dropdown.appendChild(searchInput);
        
        filter.options.forEach(opt => {
          const label = document.createElement('label');
          label.className = 'filter-option';
          label.dataset.value = opt.toLowerCase();
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = opt;
          checkbox.checked = selectedFilters[filter.key].includes(opt);
          checkbox.onchange = (e) => {
            e.stopPropagation();
            updateFilter(filter.key, opt, checkbox.checked);
          };
          
          const span = document.createElement('span');
          span.textContent = opt;
          span.style.fontSize = '14px';
          
          label.appendChild(checkbox);
          label.appendChild(span);
          dropdown.appendChild(label);
        });
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'filter-close';
        closeBtn.textContent = '閉じる';
        closeBtn.onclick = () => closeFilter(filter.key);
        dropdown.appendChild(closeBtn);
        
        filterDiv.appendChild(btn);
        filterDiv.appendChild(dropdown);
        filtersContainer.appendChild(filterDiv);
      });
    }

    function filterOptions(key, searchText) {
      const dropdown = document.querySelector(`.filter-dropdown[data-filter-key="${key}"]`);
      const options = dropdown.querySelectorAll('.filter-option');
      const search = searchText.toLowerCase();
      
      options.forEach(option => {
        const value = option.dataset.value;
        if (value.includes(search)) {
          option.classList.remove('hidden');
        } else {
          option.classList.add('hidden');
        }
      });
    }

    function toggleFilter(key) {
      const dropdown = document.querySelector(`.filter-dropdown[data-filter-key="${key}"]`);
      dropdown.classList.toggle('show');
      
      if (dropdown.classList.contains('show')) {
        const searchInput = dropdown.querySelector('.filter-search');
        searchInput.value = '';
        filterOptions(key, '');
      }
    }

    function closeFilter(key) {
      document.querySelector(`.filter-dropdown[data-filter-key="${key}"]`).classList.remove('show');
    }

    function updateFilter(key, value, checked) {
      if (checked) {
        selectedFilters[key].push(value);
      } else {
        selectedFilters[key] = selectedFilters[key].filter(v => v !== value);
      }
      loadAnalytics(true);
    }

    function addEventRow() {
      eventRows.push({ event: '', count: null });
      renderEventRows();
    }

    function removeEventRow(idx) {
      eventRows.splice(idx, 1);
      renderEventRows();
    }

    function renderEventRows() {
      const container = document.getElementById('event-rows');
      container.innerHTML = '';
      
      eventRows.forEach((row, idx) => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'event-row';
        
        const select = document.createElement('select');
        select.id = `event-select-${idx}`;
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'イベントを選択 ▼';
        select.appendChild(defaultOption);
        
        if (analyticsData) {
          analyticsData.availableEvents.forEach(e => {
            const option = document.createElement('option');
            option.value = e;
            option.textContent = e;
            option.selected = row.event === e;
            select.appendChild(option);
          });
        }
        
        select.onchange = () => loadEventCount(idx);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '削除';
        deleteBtn.onclick = () => removeEventRow(idx);
        
        const countDiv = document.createElement('div');
        countDiv.className = 'event-count';
        countDiv.id = `event-count-${idx}`;
        countDiv.textContent = row.count !== null ? row.count : '';
        
        rowDiv.appendChild(select);
        rowDiv.appendChild(deleteBtn);
        rowDiv.appendChild(countDiv);
        container.appendChild(rowDiv);
      });
    }

    async function loadEventCount(rowId) {
      try {
        const selectEl = document.getElementById(`event-select-${rowId}`);
        const event = selectEl.value;
        eventRows[rowId].event = event;
        
        if (!event) {
          eventRows[rowId].count = null;
          document.getElementById(`event-count-${rowId}`).textContent = '';
          return;
        }

        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const params = new URLSearchParams({ start: startDate, end: endDate, event });

        const res = await fetch(`${API_URL}/analytics/${projectId}/event-count?${params}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        eventRows[rowId].count = data.count;
        document.getElementById(`event-count-${rowId}`).textContent = data.count;
      } catch (err) {
        console.error('Failed to load event count:', err);
      }
    }

    function getJSTDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function initDates() {
      const now = new Date();
      const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      const jstStart = new Date(jstNow.getTime() - (30 * 24 * 60 * 60 * 1000));
      
      document.getElementById('start-date').value = getJSTDateString(jstStart);
      document.getElementById('end-date').value = getJSTDateString(jstNow);
    }

    // ログイン機能
    if (sessionStorage.getItem('loggedIn') !== 'true') {
      window.location.href = 'index.html';
    }
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('ログアウトしますか？')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    });

    async function init() {
      initDates();
      await loadProject();
      await loadSuggestions();
      await loadAnalytics();
    }

    init();

    document.getElementById('start-date').addEventListener('change', loadAnalytics);
    document.getElementById('end-date').addEventListener('change', loadAnalytics);
    document.getElementById('add-event-btn').addEventListener('click', addEventRow);
  </script>
</body>
</html>
